ins---
title: "Milk Analysis"
author: "Gustavo Reyes"
date: "10/25/2021"
output: html_document
---
#Milk Analysis: 

```{r}
#Setting Working Directory-------------------------------------
#setwd("C:/Users/gareyes3/Documents/GitHub/Share-Table-Milk/R") 
#setwd("G:/Share Table QMRA/Share-Table-QMRA/R")
#setwd(getSrcDirectory()[1])
setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) #Set working directory to the path of document
```

##Loading Libraries
```{r ,echo=FALSE}
#Opening Libary and Inputs-------------------------------------
source("Util_Library.R")
source("Functions_Full_Analysis.R")
```


##Loading Model Necessary Inputs. 
```{r}
library(tidyverse)
#Inputs and Source Files-------------------------------------

#Inputs
source("Main_Loop.R")
source("Input_Static.R")
source("Input_Functions.R")
source("Util_DFFunctions.R")
source("Util_DFWeekCreation.R")
source("Util_Counter&Lists.R")
#Functions
source("Util_Functions.R")
source("Util_CCFunctions2.R")
source("Util_VisualFunctions.R")
source("Util_Output_Functions.R")

```

#Generating Change from T and Temp Data
```{r}
Time_Temp_Profile<-read_csv("5Days-Adjusted-Temp-2hr-Cycles.csv")
Time_Temp_Profile_RC<-read_csv("5Days-Adjusted-Temp-RC.csv")
```

## Functions for growth and lag phases 
```{r}
#Function for growth and lag phase
new_growth_rate<-function(newTemp, oldMu,oldTemp = 6, T0 = -4.15){
  newMu<-((newTemp-T0)/(oldTemp-T0))* oldMu
  return (newMu)
}

#Calculation of the new lag time.
new_lag_time <- function (newTemp, oldLag, oldTemp = 6, T0 = -4.15) {
  numerator <- oldTemp -T0
  denom <- newTemp - T0
  newLag <- ( (numerator / denom)^2) * oldLag
  return(newLag)
}
```

#functions to Create a random time temp df linear. 
```{r}
#Not in use, function to create a data frame based on interval and initial and final temperature
Time_Temp_Creation<-function(Total_Time, Interval, Initial_Temperature, Final_Temperature){
  Time_Temp_df<-data.frame("min"= seq(0,Total_Time,by = Interval),
                         "tempM"  = seq(Initial_Temperature,Final_Temperature, by = ((Final_Temperature - Initial_Temperature)/(length(seq(0,Total_Time,by = Interval)) - 1) )))
}

Time_Temp_Creation_Var<-function(Total_Time, Interval, Mean_Temperature, SD_Temperature){
  Time_Temp_df<-data.frame("min"= seq(0,Total_Time,by = Interval),
                         "tempM"= rnorm(n =Total_Time+1, mean = Mean_Temperature, sd= SD_Temperature))
  return (Time_Temp_df)
}
```

```{r}
#This function calculates thee growth based on a time and temperature profile for 1 specific milk with R100084 P Paoae
Func_Growth_LagCon<-function(In_Lag_Consumed, Time_Temp_df,Interval){
  #In_Lag_Consumed= Total lag time consumed
  #Time_Temp_df = dataframe with time and temperature conditions
  #Interval = time interval in the time_temp_df in hrs. 
  Total_Lag_Consumed = In_Lag_Consumed
  Total_Growth = 0
  old_lag = 0
  NMax = 8.14
  old_mumax = 0.083508
  Growth_V = c()
  for (i in 1:nrow(Time_Temp_df)){
    if (Total_Lag_Consumed <1 && old_lag!=0){
      Lag_t_interval<-new_lag_time(newTemp = Time_Temp_df$tempM[i], oldLag = old_lag)
      Lag_Consumed<-Interval/Lag_t_interval
      Total_Lag_Consumed<-Total_Lag_Consumed+Lag_Consumed
      Growth = 0
    } else if (Total_Lag_Consumed>=1 | old_lag == 0){
      Growth = ((new_growth_rate(newTemp = Time_Temp_df$tempM[i], oldMu = old_mumax))/2.303)* 1.3209#0.684 #Converted log10 from log ln
      Total_Growth = Total_Growth + (Growth*Interval)
    }
    Growth_V = c(Growth_V,Total_Growth)
    #print(length(Growth_V))
  }
  return(list(Total_Growth,Total_Lag_Consumed,Growth_V))
}


```

#Calculating changes over time for milk in different conditions. 
```{r}
#Growth of milk over the 2 hr periods
Output_Milk<-Func_Growth_LagCon(In_Lag_Consumed = 0 ,Time_Temp_df = Time_Temp_Profile,Interval = 1/60)

Changes_Over_Time<-Output_Milk[[3]]

plot(Changes_Over_Time)

#Growth of milk using overnight storage
Output_Milk_RC<-Func_Growth_LagCon(In_Lag_Consumed = 0 ,Time_Temp_df =Time_Temp_Profile_RC,Interval = 1/60)
Changes_Over_Time_RC<-Output_Milk_RC[[3]]
```


##Running the  Model for Milk.
```{r warning=TRUE}
#Running Loop First:-------------------------------------
start_time<-Sys.time()

source("Main_Loops2.R")
```


```{r}
#AnalysysDF_RON<-AnalysysDF

  #SummaryLisr = List_Sens_Fr
  #FoodType= = "Fruit"
  #1. Start from here
  Individual_Analysis_Fr<-rbind.fill(List_Sens_Pre)
  
  #2. find the dupplicates
  #this step filters replicated based on the ID
  Individual_Analysis_Fr<-Individual_Analysis_Fr %>% 
    group_by(ID) %>% 
    filter(TotServices==max(TotServices))
  #3
  AnalysysDF<-Individual_Analysis_Fr
  
  
  AnalysysDF$Shared<-ifelse(AnalysysDF$STtimes>0, "Yes", "No")
```


#Updating Final Contaminations based on the Changes
```{r}
NMax = 8.14
for (i in 1:nrow(AnalysysDF)){
  In_Cont<-AnalysysDF$InSpoilageCon[i]
  Time<-AnalysysDF$TotTime[i]
  if (Time == 0){
    Total_Growth = 0
  }else{
    Total_Growth<-Changes_Over_Time[Time]
  }
  Final_Con<-In_Cont+Total_Growth
  if(Final_Con>NMax){
    Final_Con <- NMax
  }
  AnalysysDF$SpoilageCon[i]<-Final_Con
}

```

##Start of the Milk Analysis based on outputs'

###How many Items ended up in which locations
```{r}
library(scales)
library(forcats)

AnalysysDF %>% 
  count(Location) %>% 
  arrange(desc(n)) %>% 
  mutate(Location = fct_reorder(Location, n)) %>%
  ggplot(aes(x =Location, y = n/sum(n)*100))+
  scale_y_continuous(labels = scales::percent_format(scale = 1) )+
  geom_col()+
  labs(x = "Final Food Location", y = "Percent of milk items by location", title= "Final Location for milk-Donation happens end of week")+
  theme(plot.title = element_text(hjust = 0.5))+
  coord_flip()
  
```

###What is the distribution of time for the milk items

```{r}
AnalysysDF %>%
  ggplot(aes(x = TotTime))+
  geom_histogram()+
  scale_x_continuous(n.breaks= 10)+
  labs(x = "Time in Hours", y = "Count ", title= "Time in system by Item week")+
  theme(plot.title = element_text(hjust = 0.5))
  

```

###APC Contamination by Items

```{r}
AnalysysDF %>%
  ggplot()+
  geom_histogram(aes(x = SpoilageCon),color="darkblue", fill="lightblue",alpha= 0.3)+
  geom_histogram(aes(x = InSpoilageCon),color="darkblue", fill="lightgreen", alpha= 0.3)+
  geom_vline(xintercept =6, color= "Red")+
  scale_x_continuous(n.breaks= 10)+
  labs(x = "Phsychotroph Population Log CFU/ml", y = "Count", title= "Levels per milk carton")+
  theme(plot.title = element_text(hjust = 0.5))
```


```{r}
AnalysysDF %>% 
  group_by(ConsumedAt) %>% 
  summarise(ChangeCon = SpoilageCon-InSpoilageCon) %>% 
  filter(ConsumedAt!="") %>% 
  ggplot(aes(x = ChangeCon, fill = ConsumedAt))+
  geom_histogram(bins=50)+
  labs(x = "Change in population log CFU/ml")

```


#Relationship between Time and APC Levels
```{r}
AnalysysDF %>% 
  ggplot(aes(y = SpoilageCon, x= TotTime, fill= Shared))+
  geom_point( size =2, shape = 21, alpha = 0.7, color = "black")+
  geom_hline(yintercept =6)+
  facet_wrap(.~Location)+
  labs(x = "Time in Cafeteria System (Min)", y = "Pseudomonas Poae Population Log CFU/ml", title= "Pseudomonas Poae Population vs total time in system")+
  scale_y_continuous()+
  #scale_x_log10(n.breaks= 10)+
  theme(plot.title = element_text(hjust = 0.5))+
  theme_bw()

```

#Change in Contamination Levels due to Time
  ##Need to figure out a way to track contamination change. 
```{r}
AnalysysDF %>% 
  mutate(Change_Cont = SpoilageCon-InSpoilageCon) %>% 
  ggplot(aes(y = Change_Cont, x= TotTime, fill = Shared))+
  geom_point( size =2, shape = 21, alpha = 0.7)+
  facet_wrap(.~Location, scales = "free_x")+
  labs(x = "Time in System (min)", y = "Change Pseudomonas Poae Population Log CFU/ml", title= "Pseudomonas Poae Population vs total time in system, milk Items")+
  scale_y_continuous()+
  scale_x_log10(n.breaks= 10)+
  theme(plot.title = element_text(hjust = 0.5))+
  theme_bw()

```

```{r}

Normal<-AnalysysDF %>% 
  mutate(Change_Cont = SpoilageCon-InSpoilageCon)

mean(Normal$Change_Cont)
quantile(Normal$Change_Cont)

MostExtreme<-AnalysysDF %>% 
  mutate(Change_Cont = SpoilageCon-InSpoilageCon)

mean(MostExtreme$Change_Cont)
quantile(MostExtreme$Change_Cont)

mean((AnalysysDF$TotTime))
quantile(AnalysysDF$TotTime)

sum(AnalysysDF$Shared == "Yes")/ length(AnalysysDF$Shared)

```



#
```{r}
Pre_Data_Full %>% 
  filter(Location=="Shared")
```



